{% extends '_base.html' %}
{% load static %}

<!-- Set corresponding nav pill to active -->
{% block nav_tag %}active{% endblock nav_tag %}

{% block content %}
<div class="container mt-2 mt-md-3">
    {% if image %}
    <div class="row">
        <div class="col-12 text-center">
            <p>
                Select all objects in the image if it isn't already!
            </p>
        </div>
    </div>

    <div class="row text-center">
        <form method="POST">
            {% csrf_token %}
            <input
                type="submit"
                class="btn btn-primary me-2"
                id="skip_annotations"
                name="skip_annotations"
                value="Skip Image"
                disabled
            >
            <input
                type="submit"
                class="btn btn-primary me-2"
                id="clear_annotations"
                name="clear_annotations"
                value="Delete all boxes"
            >
            <input
                type="submit"
                class="btn btn-primary"
                id="save_annotations"
                name="save_annotations"
                value="Save Annotations"
                disabled
            >
            {% if user.is_staff %}
            <button type="button"
                    class="btn btn-primary me-2"
                    style="background-color: orange" data-toggle="modal" data-target="#staffEditModal"
            >Admin View</button>
            {% include './staff-edit-annotations.html' %}
            {% endif %}
            <div class="mt-3">
                <input
                    class="form-check-input"
                    type="checkbox"
                    {% if social_media_worthy %}checked="checked"{% endif %}
                    id="social-media-worthy"                    
                >
                <label
                    class="form-check-label"
                    for="social-media-worthy"
                >
                    &nbsp; Social Media Worthy?
                </label>                
            </div>
        </form>
    </div>
#########
#########
############ more code
{% block footer_includes %}
<!-- Annotorious generic & custom stylesheets -->
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.6.1/dist/annotorious.min.css"
>
<!-- Jquery & Annotorious -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-shape-labels@latest/dist/annotorious-shape-labels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.6.1/dist/annotorious.min.js"></script>

<!-- Bootstrap -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
<script>
    
    document.querySelector('label[for="social-media-worthy"]').addEventListener('click', function(event) {
event.preventDefault();
});
</script>


<script>
        // TODO: Move all this code to separate functions housed in separate files
        {% comment %} Create a javascript variable holding all the annotations and render annotations{% endcomment %}
        let bboxes = [
            {% for bbox in bounding_boxes %}
                {
                    "id": "{{bbox.id}}",
                    "category": "{{bbox.category_set.all.0.name}}",
                    "confidence": "{{bbox.category_set.all.0.confidence}}",
                    "x": {{bbox.x}},
                    "y": {{bbox.y}},
                    "w": {{bbox.w}},
                    "h": {{bbox.h}},
                },
            {% endfor %}
        ];
        let categories = ['animal','person','vehicle']
        let MDClassSelectorWidget = createCategoryWidget(categories)

        let anno;

        window.getAnno = function () {
            return anno;
        }

        // Set up annotations, rendering and submit hooks after the window has fully loaded
        window.addEventListener('load', function() {
            anno = renderBoundingBoxes("{{image.id}}", bboxes=bboxes, widgets=[MDClassSelectorWidget]);
            renderBoundingBoxPreviews("{{image.id}}", "annotations-preview", anno)
            anno.on("createAnnotation", function () { return renderBoundingBoxPreviews("{{image.id}}", "annotations-preview", anno)})
            anno.on("deleteAnnotation", function () { return renderBoundingBoxPreviews("{{image.id}}", "annotations-preview", anno)})
            anno.on("updateAnnotation", function () { return renderBoundingBoxPreviews("{{image.id}}", "annotations-preview", anno) })

            document.getElementById("save_annotations").disabled = false;
            document.getElementById("skip_annotations").disabled = false;

            // Function to save annotations
            function submitAnnotations(skip=false) {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                let data = {
                    'image_id': '{{image.id}}',
                    'csrfmiddlewaretoken': csrftoken,
                }

                if (skip) {
                    data['skip'] = true;
                }
                else {
                    data['initial_bboxes'] = JSON.stringify(bboxes);
                    data['annotations'] = JSON.stringify(anno.getAnnotations());
                    data['social_media_worthy'] = document.getElementById('social-media-worthy').checked;
                }

                // Send back all the bbox ids back to the server to log bbox deletions
                // Make an AJAX request
                $.ajax({
                    url: '{% url 'images:md_annotation_processor'%}',
                    method: 'POST',
                    data: data,
                    dataType: 'json',
                    success: function (data){
                        if (data.success){
                            window.location.reload();
                        }
                        else {
                            $("#status-failure").removeClass("d-none");
                            setTimeout(function(){
                                $("#status-failure").addClass("d-none");
                            }, 10000);
                        }
                    },
                })
            }

            {% if user.is_staff %}
                window.staffDeleteAnnotation = function () {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    let data = {
                        'model': arguments[0],
                        'boxId': arguments[1],
                        'annotationName': arguments[2],
                        'csrfmiddlewaretoken': csrftoken
                    }

                    $.ajax({
                        url: `{% url 'images:staff_delete_annotation'%}`,
                        method: 'POST',
                        data: data,
                        dataType: 'json',
                        success: function (data) {
                            let notifyText = document.getElementById(`notify-text-${data.name}`);

                            if (data.success) {
                                notifyText.innerHTML = `<i>Annotation "<b>${data.name}</b>" has been deleted.</i>`;
                            }
                            else {
                                notifyText.innerHTML = `There was a problem deleting <i>annotation "<b>${data.name}</b>".</i>`;
                            }
                        }
                    });
                }

                window.staffChangeAnnotation = function () {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    let data = {
                        'model': arguments[0],
                        'boxId': arguments[1],
                        'annotationName': arguments[2],
                        'newAnnotationName': arguments[3],
                        'csrfmiddlewaretoken': csrftoken
                    }

                    $.ajax({
                        url: `{% url 'images:staff_change_annotation'%}`,
                        method: 'POST',
                        data: data,
                        dataType: 'json',
                        success: function (data) {
                            let notifyText = document.getElementById(`notify-text-${data.oldName}`);

                            if (data.success) {
                                notifyText.innerHTML = `<i>Annotation "${data.oldName}" has been changed to "<b>${data.newName}</b>".<br>(Refresh page to change again.)</i>`;
                            }
                            else {
                                notifyText.innerHTML = `There was a problem changing <i>annotation "<b>${data.oldName}</b>".</i>`;
                            }
                        }
                    });
                }
            {% endif %}

            // Submit annotations to the server
            $("#save_annotations").click(function(e){
                // First, prevent the default action of the form
                e.preventDefault();
                // Then, save the annotations
                submitAnnotations(skip=false);
            });

            // Skip annotations to the server
            $("#skip_annotations").click(function(e){
                // First, prevent the default action of the form
                e.preventDefault();
                // Then, save the annotations
                submitAnnotations(skip=true);
            });
            // Skip annotations to the server
            $("#clear_annotations").click(function(e){
                // First, prevent the default action of the form
                e.preventDefault();
                // Then, save the annotations
                anno.clearAnnotations()
            });
        });
    </script>
{% endblock footer_includes %}
